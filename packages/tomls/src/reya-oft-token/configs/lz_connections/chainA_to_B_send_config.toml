# Generic Source Configuration
# Configure chainA endpoint for sending messages to chainB
# This file is reused for both directions with different variable mappings

################################# Set Messaging Libraries #######################################

# Set Send Library (Source -> Destination)
[invoke.lz_set_source_send_library]
target = ["<%= settings.chainAEndpointAddress %>"]
abi = "<%= settings.lz_endpoint_abi.setSendLibrary %>"
from = "<%= settings.owner %>"
func = "setSendLibrary"
args = [
    "<%= settings.chainAOAppAddress %>",
    "<%= settings.chainBEid %>",
    "<%= settings.chainASendLibAddress %>"
]
depends = ["invoke.reya_token_initialize"]

# Set Receive Library (Destination -> Source)
[invoke.lz_set_source_receive_library]
target = ["<%= settings.chainAEndpointAddress %>"]
abi = "<%= settings.lz_endpoint_abi.setReceiveLibrary %>"
from = "<%= settings.owner %>"
func = "setReceiveLibrary"
args = [
    "<%= settings.chainAOAppAddress %>",
    "<%= settings.chainBEid %>",
    "<%= settings.chainAReceiveLibAddress %>",
    "<%= settings.lzGracePeriod %>"
]
depends = ["invoke.lz_set_source_send_library"]

################################# Set Send Configuration #######################################

# ABI encoding constants for UlnConfig struct and Executor config
[var.config_encoding]
executorConfig = "0000000000000000000000000000000000000000000000000000000000002710"  # 10000 in decimal: max message size or gas limit
tupleOffset = "0000000000000000000000000000000000000000000000000000000000000020"  # 32 bytes: offset to tuple start
requiredDVNsOffset = "00000000000000000000000000000000000000000000000000000000000000c0"  # 192 bytes: offset to requiredDVNs array
optionalDVNsOffset = "0000000000000000000000000000000000000000000000000000000000000100"  # 256 bytes: offset to optionalDVNs array
optionalDVNsLength = "0000000000000000000000000000000000000000000000000000000000000000"  # 0: no optional DVNs
addressPadding = "000000000000000000000000"  # 12 bytes: left-padding for 20-byte address to 32 bytes

# On Source Endpoint, set Destination DVN and Executor config for outbound messages
# UlnConfig struct encoding:
# - tupleOffset: offset to tuple start
# - confirmations (uint64), requiredDVNCount (uint8), optionalDVNCount (uint8), optionalDVNThreshold (uint8)
# - requiredDVNsOffset: offset to requiredDVNs array (192 bytes from tuple start)
# - optionalDVNsOffset: offset to optionalDVNs array (256 bytes from tuple start)
# - requiredDVNs.length, requiredDVNs[0] (address padded to 32 bytes)
# - optionalDVNsLength (0 in this case)
[invoke.lz_set_source_send_config]
target = ["<%= settings.chainAEndpointAddress %>"]
abi = "<%= settings.lz_endpoint_abi.setConfig %>"
from = "<%= settings.owner %>"
func = "setConfig"
args = [
    "<%= settings.chainAOAppAddress %>",
    "<%= settings.chainASendLibAddress %>",
    [
        {eid = "<%= settings.chainBEid %>", configType = 1, config = "0x<%= settings.executorConfig %><%= settings.addressPadding %><%= settings.chainAExecutorAddress.slice(2) %>"},
        {eid = "<%= settings.chainBEid %>", configType = 2, config = "0x<%= settings.tupleOffset %><%= hexZeroPad(settings.chainBLzConfirmations, 32).slice(2) %><%= hexZeroPad(settings.lzRequiredDVNCount, 32).slice(2) %><%= hexZeroPad(settings.lzOptionalDVNCount, 32).slice(2) %><%= hexZeroPad(settings.lzOptionalDVNThreshold, 32).slice(2) %><%= settings.requiredDVNsOffset %><%= settings.optionalDVNsOffset %><%= hexZeroPad(settings.lzRequiredDVNCount, 32).slice(2) %><%= settings.addressPadding %><%= settings.chainALzRequiredDVN1.slice(2) %><%= settings.optionalDVNsLength %>"}
    ]
]
depends = ["invoke.lz_set_source_receive_library", "var.config_encoding", "var.lz_common_config", "var.layerzero_chainA_config", "var.layerzero_chainB_config", "var.lz_endpoint_abi"]